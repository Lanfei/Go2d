<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\display\DisplayObject.js - Go2d</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Go2d" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.6.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Class.html">Class</a></li>
                                <li><a href="../classes/Director.html">Director</a></li>
                                <li><a href="../classes/DisplayObject.html">DisplayObject</a></li>
                                <li><a href="../classes/Ease.html">Ease</a></li>
                                <li><a href="../classes/Event.html">Event</a></li>
                                <li><a href="../classes/EventEmitter.html">EventEmitter</a></li>
                                <li><a href="../classes/go2d.html">go2d</a></li>
                                <li><a href="../classes/ImageView.html">ImageView</a></li>
                                <li><a href="../classes/Matrix.html">Matrix</a></li>
                                <li><a href="../classes/ObjectPool.html">ObjectPool</a></li>
                                <li><a href="../classes/ResizeEvent.html">ResizeEvent</a></li>
                                <li><a href="../classes/ResourceLoader.html">ResourceLoader</a></li>
                                <li><a href="../classes/ScrollView.html">ScrollView</a></li>
                                <li><a href="../classes/Sprite.html">Sprite</a></li>
                                <li><a href="../classes/Stage.html">Stage</a></li>
                                <li><a href="../classes/TextField.html">TextField</a></li>
                                <li><a href="../classes/TouchEvent.html">TouchEvent</a></li>
                                <li><a href="../classes/Tween.html">Tween</a></li>
                                <li><a href="../classes/URLRequest.html">URLRequest</a></li>
                                <li><a href="../classes/Vector.html">Vector</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/go2d.html">go2d</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\display\DisplayObject.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * 显示对象基类，实现了显示对象的基本渲染和事件逻辑，显示对象元素类和舞台类都基于此类。
 * @author Lanfei
 * @class DisplayObject
 * @extends EventEmitter
 *
 * @constructor
 * @param {object} canvas 用于渲染的画布对象
 */
var DisplayObject = go2d.DisplayObject = EventEmitter.extend({
	__init: function(canvas) {
		this._super();

		/**
		 * 用于渲染的画布对象
		 * @readonly
		 * @property canvas
		 * @type object
		 */
		this.canvas = canvas || document.createElement(&#x27;canvas&#x27;);

		/**
		 * 画布的上下文对象
		 * @readonly
		 * @property context
		 * @type object
		 */
		this.context = this.canvas.getContext(&#x27;2d&#x27;);

		/**
		 * 用于标识该对象的名字，该属性在兄弟对象中应该唯一
		 * @property name
		 * @type string
		 */
		this.name = &#x27;&#x27;;

		/**
		 * 用于标识该对象的标签
		 * @property tag
		 * @type string
		 */
		this.tag = &#x27;&#x27;;

		/**
		 * 该对象所属的舞台对象
		 * @readonly
		 * @property stage
		 * @type Stage
		 */
		this.stage = null;

		/**
		 * 是否已暂停
		 * @property paused
		 * @type Boolean
		 * @default false
		 */
		this.paused = false;

		/**
		 * 是否可点击
		 * @property touchable
		 * @type Boolean
		 * @default true
		 */
		this.touchable = true;

		/**
		 * 子节点是否可点击
		 * @property touchChildren
		 * @type Boolean
		 * @default true
		 */
		this.touchChildren = true;

		/**
		 * 是否需要重新渲染
		 * @protected
		 * @property _dirty
		 * @type Boolean
		 * @default true
		 */
		this._dirty = true;

		/**
		 * 上一帧时间戳
		 * @protected
		 * @property _prevFrame
		 * @type number
		 */
		this._prevFrame = null;

		/**
		 * 触摸标识数组
		 * @protected
		 * @property _touches
		 * @type Array
		 */
		this._touches = [];

		/**
		 * 子对象数组
		 * @protected
		 * @property _children
		 * @type Array
		 */
		this._children = [];

		/**
		 * 遮罩层
		 * @property mask
		 * @type Sprite
		 */
		this._mask = null;

		var properties = {

			/**
			 * 水平方向锚点偏移比例
			 * @property anchorX
			 * @type number
			 * @default 0
			 */
			anchorX: 0,

			/**
			 * 垂直方向锚点偏移比例
			 * @property anchorY
			 * @type number
			 * @default 0
			 */
			anchorY: 0,

			/**
			 * 水平方向锚点偏移像素
			 * @property anchorOffsetX
			 * @type number
			 * @default 0
			 */
			anchorOffsetX: 0,

			/**
			 * 垂直方向锚点偏移像素
			 * @property anchorOffsetY
			 * @type number
			 * @default 0
			 */
			anchorOffsetY: 0,

			/**
			 * 不透明度
			 * @property opacity
			 * @type number
			 * @default 1
			 */
			opacity: 1,

			/**
			 * 背景颜色或样式
			 * @property background
			 * @type null|string|Object
			 * @default null
			 */
			background: null
		};
		forEach(properties, function(value, key) {
			Object.defineProperty(this, key, {
				set: function(value) {
					if (properties[key] !== value) {
						properties[key] = value;
					}
					this.update();
				},
				get: function() {
					return properties[key];
				}
			});
		}, this);

		/**
		 * 宽度
		 * @property width
		 * @type number
		 */
		Object.defineProperty(this, &#x27;width&#x27;, {
			set: function(width) {
				this._onResize(width, this.canvas.height);
			},
			get: function() {
				return this.canvas.width;
			}
		});

		/**
		 * 高度
		 * @property height
		 * @type number
		 */
		Object.defineProperty(this, &#x27;height&#x27;, {
			set: function(height) {
				this._onResize(this.canvas.width, height);
			},
			get: function() {
				return this.canvas.height;
			}
		});

		Director.getInstance().on(&#x27;tick&#x27;, this._tick, this);
	},
	_onTouch: function(event) {
		if (!this.touchable) {
			return;
		}
		var type = event.type,
			propagationStopped = false;
		if (this.touchChildren) {
			var children = this._children,
				identifier = event.identifier,
				offset = this.getAnchorOffset(),
				touchPos = new Vector(event.x, event.y);
			for (var i = children.length - 1; i &gt;= 0; --i) {
				var child = children[i];
				if (child.visible &amp;&amp; child.touchable) {
					var emit = false,
						touches = child._touches,
						subPos = child.getTransform().translate(offset).invert().multiply(touchPos),
						inRect = subPos.x &gt;= 0 &amp;&amp; subPos.y &gt;= 0 &amp;&amp; subPos.x &lt;= child.width &amp;&amp; subPos.y &lt;= child.height;
					switch (type) {
						case &#x27;touchstart&#x27;:
							if (inRect) {
								/**
								 * 触摸开始事件
								 * @event touchstart
								 * @param {go2d.TouchEvent} event 触摸事件对象
								 */
								emit = true;
								touches[identifier] = true;
							}
							break;
						case &#x27;touchmove&#x27;:
							if (touches[identifier]) {
								/**
								 * 触摸移动事件
								 * @event touchmove
								 * @param {go2d.TouchEvent} event 触摸事件对象
								 */
								emit = true;
							}
							break;
						case &#x27;touchend&#x27;:
							if (touches[identifier]) {
								/**
								 * 触摸结束事件
								 * @event touchend
								 * @param {go2d.TouchEvent} event 触摸事件对象
								 */
								emit = true;
								touches[identifier] = false;
							}
							break;
						case &#x27;touchtap&#x27;:
							if (inRect &amp;&amp; touches[identifier] !== undefined) {
								/**
								 * 触摸点击事件
								 * @event touchtap
								 * @param {go2d.TouchEvent} event 触摸事件对象
								 */
								emit = true;
							}
							delete touches[identifier];
							break;
					}
					if (emit) {
						var subEvent = new TouchEvent(type, subPos.x, subPos.y, event.globalX, event.globalY, identifier);
						child._onTouch(subEvent);
						propagationStopped = subEvent.isPropagationStopped();
						break;
					}
				}
			}
		}
		if (propagationStopped) {
			event.stopPropagation();
		} else {
			this.emit(type, event);
		}
	},
	_onAddedToStage: function(stage) {
		/**
		 * 添加到舞台事件
		 * @event addedtostage
		 * @param {go2d.Stage} stage 舞台对象
		 */
		this.stage = stage;
		this.emit(&#x27;addedtostage&#x27;, stage);
		forEach(this._children, function(child) {
			child._onAddedToStage(stage);
		});
	},
	_onRemovedFromStage: function(stage) {
		/**
		 * 移除出舞台事件
		 * @event removedfromstage
		 * @param {go2d.Stage} stage 舞台对象
		 */
		this.stage = null;
		this.emit(&#x27;removedfromstage&#x27;, stage);
		forEach(this._children, function(child) {
			child._onRemovedFromStage(stage);
		});
	},
	_onResize: function(width, height) {
		var oldWidth = this.width,
			oldHeight = this.height;
		if (width === oldWidth &amp;&amp; height === oldHeight) {
			return;
		}
		var event = new ResizeEvent({
			width: oldWidth,
			height: oldHeight
		}, {
			width: width,
			height: height
		});
		/**
		 * 宽高变化事件
		 * @event resize
		 * @param {go2d.ResizeEvent} event 宽高变化事件对象
		 */
		this.emit(&#x27;resize&#x27;, event);
		if (!event.isDefaultPrevented()) {
			this.canvas.width = width;
			this.canvas.height = height;
			this.update();
		}
	},
	/**
	 * 进入下一帧，该方法应只由引擎本身调用
	 * @function _tick
	 * @return {this}
	 */
	_tick: function(deltaTime) {
		if (!this.paused) {
			/**
			 * 步进（进入下一帧）事件
			 * @event step
			 * @param {number} deltaTime 两帧时间差
			 */
			this.emit(&#x27;step&#x27;, deltaTime);
		}
		return this;
	},
	/**
	 * 绘制子对象
	 * @protected
	 * @function _drawChild
	 * @param {go2d.Sprite} child 要绘制的对象
	 * @param {string} [blendMode] 混合模式
	 * @return {this}
	 */
	_drawChild: function(child, blendMode) {
		var ctx = this.context,
			matrix = child.getTransform();

		child.render();

		ctx.globalAlpha = child.opacity;
		ctx.globalCompositeOperation = blendMode || child.blendMode;

		if (matrix.a === 1 &amp;&amp; matrix.b === 0 &amp;&amp; matrix.c === 0 &amp;&amp; matrix.d === 1) {
			ctx.drawImage(child.canvas, matrix.tx, matrix.ty, child.width, child.height);
		} else {
			ctx.save();
			ctx.setTransform.apply(ctx, matrix.toArray());
			ctx.drawImage(child.canvas, 0, 0, child.width, child.height);
			ctx.restore();
		}
	},
	/**
	 * 渲染该对象
	 * @function render
	 * @return {this}
	 */
	render: function() {
		if (this._dirty) {
			var ctx = this.context,
				children = this._children,
				event = new Event(&#x27;render&#x27;),
				offset = this.getAnchorOffset();
			ctx.setTransform(1, 0, 0, 1, offset.x, offset.y);
			ctx.clearRect(-offset.x, -offset.y, this.width, this.height);
			ctx.beginPath();
			if (this.background) {
				ctx.save();
				ctx.fillStyle = this.background;
				ctx.fillRect(-offset.x, -offset.y, this.width, this.height);
				ctx.restore();
			}
			/**
			 * 开始渲染事件
			 * @event render
			 * @param {go2d.Event} event 事件对象
			 */
			this.emit(&#x27;render&#x27;, event);
			if (!event.isDefaultPrevented()) {
				forEach(children, function(child) {
					if (child.visible &amp;&amp; child.opacity) {
						this._drawChild(child);
					}
				}, this);
				if (this._mask) {
					this._drawChild(this._mask, &#x27;destination-in&#x27;);
				}
			}
			this._dirty = false;
			/**
			 * 绘制完毕事件
			 * @event paint
			 * @param {object} context 绘制上下文对象
			 */
			this.emit(&#x27;paint&#x27;, ctx);
		}
		return this;
	},
	/**
	 * 获取锚点偏移
	 * @function getAnchorOffset
	 * @return {Object} 锚点锚点偏移
	 */
	getAnchorOffset: function() {
		return new Vector(
			this.anchorOffsetX + this.anchorX * this.width,
			this.anchorOffsetY + this.anchorY * this.height
		);
	},
	/**
	 * 更新对象渲染状态，当对象的属性改变将影响其渲染结果时调用
	 * @function update
	 * @return {this}
	 */
	update: function() {
		this._dirty = true;
		this.updateParent();
		return this;
	},
	/**
	 * 更新父对象渲染状态，某些情况下，对象属性的改变并不影响本身的渲染，而只影响父元素的渲染，此时只需重新渲染父对象即可
	 * @function update
	 * @return {this}
	 */
	updateParent: function() {
		if (this.parent) {
			this.parent.update();
		}
		return this;
	},
	/**
	 * 添加子对象
	 * @function addChild
	 * @param {go2d.DisplayObject} child 要添加的子对象
	 * @return {this}
	 */
	addChild: function(child) {
		this.addChildAt(child);
		return this;
	},
	/**
	 * 在指定深度添加子对象
	 * @function addChildAt
	 * @param {go2d.DisplayObject} child 要添加的子对象
	 * @param {number} index 深度，数值越小层级越低
	 * @return {this}
	 */
	addChildAt: function(child, index) {
		if (child.parent) {
			if (child.parent.getMask() === child) {
				child.parent.removeMask();
			} else {
				child.parent.removeChild(child);
			}
		}
		child.parent = this;
		if (this.stage) {
			child._onAddedToStage(this.stage);
		}
		if (index === undefined || index &lt; 0) {
			this._children.push(child);
		} else {
			this._children.splice(index, 0, child);
		}
		this.update();
		return this;
	},
	/**
	 * 获取指定名字的子对象
	 * @function getChildByName
	 * @param {string} name 子对象名字
	 * @return {go2d.DisplayObject} 对应的子对象
	 */
	getChildByName: function(name) {
		var child;
		forEach(this._children, function(item) {
			if (item.name === name) {
				child = item;
				return false;
			}
		});
		return child;
	},
	/**
	 * 获取指定标签的子对象
	 * @function getChildrenByTag
	 * @param {string} tag 子对象标签
	 * @return {Array} 对应的子对象数组
	 */
	getChildrenByTag: function(tag) {
		var children = [];
		forEach(this._children, function(item) {
			if (item.tag === tag) {
				children.push(item);
			}
		});
		return children;
	},
	/**
	 * 获取指定深度的子对象
	 * @function getChildAt
	 * @param {number} index 子对象深度
	 * @return {go2d.DisplayObject} 对应的子对象
	 */
	getChildAt: function(index) {
		return this._children[index];
	},
	/**
	 * 获取指定子对象的深度
	 * @function getChildIndex
	 * @param {go2d.DisplayObject} child 对应的子对象
	 * @return {number} 子对象深度
	 */
	getChildIndex: function(child) {
		var index = -1;
		forEach(this._children, function(item, i) {
			if (item === child) {
				index = i;
			}
		});
		return index;
	},
	/**
	 * 交换两个子对象的深度
	 * @function swapChildren
	 * @param {go2d.DisplayObject} child1 要交换的子对象一
	 * @param {go2d.DisplayObject} child2 要交换的子对象二
	 * @return {this}
	 */
	swapChildren: function(child1, child2) {
		var index1 = this.getChildIndex(child1);
		var index2 = this.getChildIndex(child2);
		if (index1 &gt;= 0 &amp;&amp; index2 &gt;= 0) {
			this.swapChildrenAt(index1, index2);
		}
		return this;
	},
	/**
	 * 交换两个子对象的深度
	 * @function swapChildrenAt
	 * @param {number} index1 要交换的子对象深度一
	 * @param {number} index2 要交换的子对象深度二
	 * @return {this}
	 */
	swapChildrenAt: function(index1, index2) {
		if (index1 !== index2) {
			var child1 = this._children[index1];
			var child2 = this._children[index2];
			if (child1 &amp;&amp; child2) {
				this._children[index1] = child2;
				this._children[index2] = child1;
				this.update();
			}
		}
		return this;
	},
	/**
	 * 排列子对象
	 * @function sortChildren
	 * @param {function} compare 用于比较的函数
	 * @return {this}
	 */
	sortChildren: function(compare) {
		this._children.sort(compare);
		return this;
	},
	/**
	 * 获取所有子对象
	 * @function getAllChildren
	 * @return {Array} 所有子对象数组
	 */
	getAllChildren: function() {
		return this._children;
	},
	/**
	 * 移除指定的子对象
	 * @function removeChild
	 * @param {go2d.DisplayObject} child 对应的子对象
	 * @param {Boolean} cleanup 是否销毁子对象
	 * @return {this}
	 */
	removeChild: function(child, cleanup) {
		var children = this._children;
		for (var i = children.length - 1; i &gt;= 0; --i) {
			if (children[i] === child) {
				this.removeChildAt(i, cleanup);
			}
		}
		return this;
	},
	/**
	 * 移除指定深度的子对象
	 * @function removeChildAt
	 * @param {number} index 子对象的深度
	 * @param {Boolean} cleanup 是否销毁子对象
	 * @return {this}
	 */
	removeChildAt: function(index, cleanup) {
		var child = this._children.splice(index, 1)[0];
		if (child) {
			if (cleanup) {
				child.dispose();
			} else {
				child.parent = null;
				if (child.stage) {
					child._onRemovedFromStage(child.stage);
				}
			}
			this.update();
		}
		return this;
	},
	/**
	 * 移除指定名字的子对象
	 * @function removeChildrenByName
	 * @param {string} name 子对象的名字
	 * @param {Boolean} cleanup 是否销毁子对象
	 * @return {this}
	 */
	removeChildrenByName: function(name, cleanup) {
		var children = this._children;
		for (var i = children.length - 1; i &gt;= 0; --i) {
			if (children[i].name === name) {
				this.removeChildAt(i, cleanup);
				break;
			}
		}
		return this;
	},
	/**
	 * 移除指定标签的子对象
	 * @function removeChildrenByTag
	 * @param {string} tag 子对象的标签
	 * @param {Boolean} cleanup 是否销毁子对象
	 * @return {this}
	 */
	removeChildrenByTag: function(tag, cleanup) {
		var children = this._children;
		for (var i = children.length - 1; i &gt;= 0; --i) {
			if (children[i].tag === tag) {
				this.removeChildAt(i, cleanup);
			}
		}
		return this;
	},
	/**
	 * 移除所有子对象
	 * @function removeAllChildren
	 * @param {Boolean} cleanup 是否销毁子对象
	 * @return {this}
	 */
	removeAllChildren: function(cleanup) {
		forEach(this._children, function(child) {
			child.parent = null;
			if (child.stage) {
				child._onRemovedFromStage(child.stage);
			}
			if (cleanup) {
				child.dispose();
			}
		});
		this._children = [];
		this.update();
		return this;
	},
	/**
	 * 设置遮罩对象
	 * @function setMask
	 * @param {go2d.Sprite} mask 遮罩对象
	 * @return {this}
	 */
	setMask: function(mask) {
		if (!mask) {
			this.removeMask();
		}
		if (mask.parent) {
			if (mask.parent.getMask() === mask) {
				mask.parent.removeMask();
			} else {
				mask.parent.removeChild(mask);
			}
		}
		mask.parent = this;
		if (this.stage) {
			mask._onAddedToStage(this.stage);
		}
		this._mask = mask;
		this.update();
		return this;
	},
	/**
	 * 获取遮罩对象
	 * @function getMask
	 * @return {go2d.Sprite}
	 */
	getMask: function() {
		return this._mask;
	},
	/**
	 * 移除遮罩对象
	 * @function removeMask
	 * @param {Boolean} cleanup 是否销毁遮罩对象
	 * @return {this}
	 */
	removeMask: function(cleanup) {
		var mask = this._mask;
		mask.parent = null;
		if (cleanup) {
			mask.dispose();
		}
		this._mask = null;
		this.update();
	},
	/**
	 * 开始该对象的帧播放
	 * @function play
	 * @return {this}
	 */
	play: function() {
		this.paused = false;
		return this;
	},
	/**
	 * 暂停该对象的帧播放
	 * @function pause
	 * @return {this}
	 */
	pause: function() {
		this.paused = true;
		return this;
	},
	/**
	 * 释放对象内存
	 * @function dispose
	 */
	dispose: function() {
		if (this.parent) {
			this.parent.removeChild(this);
		}
		this.removeAllChildren(true);

		Director.getInstance().off(&#x27;tick&#x27;, this._tick, this);

		this._super();
	}
});
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>

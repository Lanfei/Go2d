/*! Go2d 1.3.1 | A lightweight HTML5 game engine*/
!function(a,b){"function"==typeof define?define(b):a.go2d=b()}(this,function(){function a(a){return function(b){return{}.toString.call(b)==="[object "+a+"]"}}var b={version:"1.3.1"},c=b.isObject=a("Object"),d=(b.isNumber=a("Number"),b.isString=a("String")),e=b.isFunction=a("Function"),f=b.isArray=Array.isArray||a("Array"),g=b.forEach=function(a,b,d){if(d=d||a,f(a))a.forEach(b,d);else if(c(a))for(var e in a)if(b.call(d,a[e],e,a)===!1)break},h=b.Class=function(){};h.extend=function(a,b){function c(){return this._super=d,this.constructor=c,e(this.__init)?this.__init.apply(this,arguments):void 0}var d=this.prototype;return c.prototype=Object.create(d),c.extend=h.extend,g(a,function(b,f){var g=Object.getOwnPropertyDescriptor(a,f);g.get||g.set?Object.defineProperty(c.prototype,f,g):c.prototype[f]=e(b)&&/\bthis\._super\(/.test(b)?function(a,b){return function(){this._super=d[a];var c=b.apply(this,arguments);return this._super=d,c}}(f,b):b}),g(b,function(a,b){c[b]=a}),c};{var i=(b.ObjectPool=h.extend({__init:function(a,b){this._pool=[],this._class=a,this.size=b||30,Object.defineProperty(this,"length",{set:function(){},get:function(){return this._pool.length}})},create:function(){return new this._class},get:function(){return this._pool.length?this._pool.shift():this.create()},recycle:function(a){return this._pool.push(a),this._pool.length>this._size&&this._pool.shift(),this},clear:function(){return this._pool=[],this},dispose:function(){this._pool=null,this._constructor=null}}),b.Director=h.extend({__init:function(a,b){b=b||{},this.fps=0,this.stage=a,this.paused=!0,this.frameRate=b.frameRate||60,this._initEvent(),this._initTimer(),this._timer=null,this._prevTime=null},_initEvent:function(){var a=this,b=!1,c=["","ms","moz","webkit"];g(c,function(c){return void 0!==document[c+"hidden"]?(document.addEventListener(c+"visibilitychange",function(){document[c+"hidden"]?a.paused||(a.pause(),b=!0):b&&(b=!1,a.play())}),!1):void 0})},_initTimer:function(){function a(a){return setTimeout(a,1e3/c)}function b(a){return clearTimeout(a)}var c=this.frameRate;60===this.frameRate?(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||a,this.setAnimationInterval=function(a){return requestAnimationFrame.call(null,a)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame||b,this.clearAnimationInterval=function(a){cancelAnimationFrame(a)}):(this.setAnimationInterval=a,this.clearAnimationInterval=b)},mainLoop:function(){var a,b=+new Date;this._prevTime?(a=Math.min(1e3,b-this._prevTime),this.fps=Math.round(1e3/a)):a=Math.round(1e3/this.frameRate),this.stage.render().tick(a),this._prevTime=b},play:function(){var a=this;this._timer=this.setAnimationInterval(function(){a.mainLoop(),a.play()}),this.paused=!1},pause:function(){this.clearAnimationInterval(this._timer),this.paused=!0,this._prevTime=0}}),b.Vector=h.extend({__init:function(a,b){this.set(a,b),Object.defineProperty(this,"length",{set:function(){},get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}})},set:function(a,b){return a instanceof i?this.set(a.x,a.y):(this.x=a||0,this.y=b||0),this},add:function(a){this.x+=a.x,this.y+=a.y},subtract:function(a){this.x-=a.x,this.y-=a.y},divide:function(a){this.x/=a.x,this.y/=a.y},dotProduct:function(a){return this.x*a.x+this.y*a.y},normalize:function(){var a=this.length;return this.x=this.x/a,this.y=this.y/a,this},scale:function(a,b){this.x*=a,this.y*=void 0===b?a:b},rotate:function(a){var b=this.x,c=this.y;return this.x=b*Math.cos(a)-c*Math.sin(a),this.y=b*Math.sin(a)+c*Math.cos(a),this},angle:function(){return Math.atan2(this.y,this.x)},distance:function(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))},clone:function(){return new i(this)}})),j=b.Matrix=h.extend({__init:function(){this.set.apply(this,arguments)},set:function(a,b,c,d,e,f){return 6===arguments.length?(this.a=a,this.b=b,this.c=c,this.d=d,this.tx=e,this.ty=f):a instanceof j?this.set(a.a,a.b,a.c,a.d,a.tx,a.ty):this.identity(),this},identity:function(){this.set(1,0,0,1,0,0)},invert:function(){var a=this.a,b=this.b,c=this.c,d=this.d,e=this.tx,f=this.ty,g=a*d-c*b;return this.a=d/g,this.b=-b/g,this.c=-c/g,this.d=a/g,this.tx=(c*f-d*e)/g,this.ty=(b*e-a*f)/g,this},multiply:function(a,b,c,d,e,f){var g=this.a,h=this.b,i=this.c,j=this.d,k=this.tx,l=this.ty;return this.a=a*g+c*h,this.b=b*g+d*h,this.c=a*i+c*j,this.d=b*i+d*j,this.tx=a*k+c*l+e,this.ty=b*k+d*l+f,this},vectorMultiply:function(a){var b=this.a*a.x+this.c*a.y+this.tx,c=this.b*a.x+this.d*a.y+this.ty;return{x:b,y:c}},append:function(a){return this.multiply(a.a,a.b,a.c,a.d,a.tx,a.ty)},scale:function(a,b){return this.multiply(a,0,0,void 0===b?a:b,0,0)},rotate:function(a){var b=Math.sin(a),c=Math.cos(a);return this.multiply(c,b,-b,c,0,0)},skew:function(a,b){return this.multiply(1,a,b,1,0,0)},translate:function(a,b){return this.multiply(1,0,0,1,a,b)},clone:function(){return new j(this)}}),k=b.EventDispatcher=h.extend({__init:function(){this.__events={}},on:function(a,b){if(1===arguments.length){var c=arguments[0];for(a in c)this.on(a,c[a])}else a=a.toLowerCase(),this.__events[a]=this.__events[a]||[],this.__events[a].push(b);return this},off:function(a,b){if(a=a.toLowerCase(),void 0===b)return delete this.__events[a],this;for(var c=this.__events[a]||[],d=c.length-1;d>=0;--d)if(c[d]===b){c.splice(d,1);break}return this},emit:function(a,b){a=a.toLowerCase();var c=this.__events[a]||[],d=Array.prototype.slice.call(arguments,1);return g(c,function(a){return e(a)&&a.apply(this,d)===!1?(b instanceof l&&(b.preventDefault(),b.stopPropagation()),!1):void 0},this),this},dispose:function(){this.__events=null}}),l=b.Event=h.extend({__init:function(a,b){for(var c in b)this[c]=b[c];this.type=a,this._stoped=!1,this._defaultPrevented=!1},stopPropagation:function(){this._stoped=!0},isStopped:function(){return this._stoped},preventDefault:function(){this._defaultPrevented=!0},isDefaultPrevented:function(){return this._defaultPrevented}}),m=l.TouchEvent=l.extend({__init:function(a,b,c,d,e,f){this._super(a,{x:b,y:c,globalX:d,globalY:e,identifier:f})}}),n=l.ResizeEvent=l.extend({__init:function(a,b){this._super("resize",{oldSize:a,newSize:b})}}),o=b.URLRequest=k.extend({__init:function(a,b){b=b||{},this._super(),this.url=a,this.type=b.type||"GET",this.dataType=b.dataType,this.contentType=b.contentType,this.xhr=new window.XMLHttpRequest},send:function(a){var b=null,c=this,e=this.xhr,f=this.url,h=this.type,i=this.dataType;return d(a)?b=a:(b="",g(a,function(a,c){b+="&"+c+"="+a}),b=b.slice(1)),b&&"GET"===h.toUpperCase()&&(f+=(f.indexOf("?")<0?"?":"&")+b,b=null),e.open(h,f,!0),e.setRequestHeader("Content-Type",this.contentType||"application/x-www-form-urlencoded"),e.onreadystatechange=function(){if(4==e.readyState)if(200==e.status){var a;if("xml"===i){if(a=e.responseXML,null===a)return void c.emit("error",e,"parseError")}else if("json"===i)try{a=JSON.parse(e.responseText)}catch(b){return void c.emit("error",e,"parseError")}else a=e.responseText;c.emit("success",a)}else c.emit("error",e,e.status?"error":"abort")},e.send(b),this},abort:function(){return this.xhr.abort(),this}}),p=b.Resource=k.extend({__init:function(a){this._super(),this._data=a,this._resources=[],this.total=0,this.errorCount=0,this.loadedCount=0},_load:function(a,b,c,d){var e,f=this;switch(e=d?function(){f._onError(a)}:function(){f._load(a,b,c,!0)},c){case p.Type.XML:case p.Type.JSON:case p.Type.TEXT:var g=new o(b,{dataType:c});g.on("success",function(b){f._save(a,b),f._onLoad()}),g.on("error",e),g.send();break;case p.Type.IMAGE:var h=new Image;h.addEventListener("load",function(){f._onLoad()}),h.addEventListener("error",e),h.src=b,this._save(a,h);break;case p.Type.AUDIO:var i=document.createElement("audio");if(i.addEventListener("canplay",function(){f._onLoad()}),i.addEventListener("error",e),i.src=b,this._save(a,i),"ontouchend"in document){var j=!1,k=i.play,l=i.pause;i.play=function(){j=!0,k.call(this)},i.pause=function(){j=!1,l.call(this)},document.addEventListener("touchstart",function(){j?i.play():(i.play(),i.pause()),document.removeEventListener("touchstart",arguments.callee,!0)},!0)}break;default:f._request(b,{success:function(b){f._save(a,b.response),f._onLoad()},error:e})}},_save:function(a,b){this._resources[a]=b},_onLoad:function(){this.emit("progress",++this.loadedCount,this.total),this._checkStatus()},_onError:function(a){++this.errorCount,this.emit("error",a),this._checkStatus()},_checkStatus:function(){this.loadedCount===this.total&&this.emit("complete"),this.loadedCount+this.errorCount===this.total&&this.emit("finish")},load:function(){var a=this._data;for(var b in a){var c=a[b];this.total+=c.length;for(var d=0,e=c.length;e>d;++d){var f=c[d];this._load(f.name,f.url,b)}}return delete this._data,this},get:function(a){return this._resources[a]},destroy:function(a){return delete this._resources[a]},destroyAll:function(){this._resources=[]}},{Type:{XML:"xml",JSON:"json",TEXT:"text",IMAGE:"image",AUDIO:"audio",BINARY:"binary"}}),q=b.Ease=h.extend({},{linear:function(a,b,c,d){return c*a/d+b},easeInQuad:function(a,b,c,d,e){return d*(b/=e)*b+c},easeOutQuad:function(a,b,c,d,e){return-d*(b/=e)*(b-2)+c},easeInOutQuad:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b+c:-d/2*(--b*(b-2)-1)+c},easeInCubic:function(a,b,c,d,e){return d*(b/=e)*b*b+c},easeOutCubic:function(a,b,c,d,e){return d*((b=b/e-1)*b*b+1)+c},easeInOutCubic:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b+c:d/2*((b-=2)*b*b+2)+c},easeInQuart:function(a,b,c,d,e){return d*(b/=e)*b*b*b+c},easeOutQuart:function(a,b,c,d,e){return-d*((b=b/e-1)*b*b*b-1)+c},easeInOutQuart:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b+c:-d/2*((b-=2)*b*b*b-2)+c},easeInQuint:function(a,b,c,d,e){return d*(b/=e)*b*b*b*b+c},easeOutQuint:function(a,b,c,d,e){return d*((b=b/e-1)*b*b*b*b+1)+c},easeInOutQuint:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b*b+c:d/2*((b-=2)*b*b*b*b+2)+c},easeInSine:function(a,b,c,d,e){return-d*Math.cos(b/e*(Math.PI/2))+d+c},easeOutSine:function(a,b,c,d,e){return d*Math.sin(b/e*(Math.PI/2))+c},easeInOutSine:function(a,b,c,d,e){return-d/2*(Math.cos(Math.PI*b/e)-1)+c},easeInExpo:function(a,b,c,d,e){return 0===b?c:d*Math.pow(2,10*(b/e-1))+c},easeOutExpo:function(a,b,c,d,e){return b===e?c+d:d*(-Math.pow(2,-10*b/e)+1)+c},easeInOutExpo:function(a,b,c,d,e){return 0===b?c:b===e?c+d:(b/=e/2)<1?d/2*Math.pow(2,10*(b-1))+c:d/2*(-Math.pow(2,-10*--b)+2)+c},easeInCirc:function(a,b,c,d,e){return-d*(Math.sqrt(1-(b/=e)*b)-1)+c},easeOutCirc:function(a,b,c,d,e){return d*Math.sqrt(1-(b=b/e-1)*b)+c},easeInOutCirc:function(a,b,c,d,e){return(b/=e/2)<1?-d/2*(Math.sqrt(1-b*b)-1)+c:d/2*(Math.sqrt(1-(b-=2)*b)+1)+c},easeInElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;return 0===b?c:1===(b/=e)?c+d:(g||(g=.3*e),h<Math.abs(d)?(h=d,f=g/4):f=g/(2*Math.PI)*Math.asin(d/h),-(h*Math.pow(2,10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g))+c)},easeOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;return 0===b?c:1===(b/=e)?c+d:(g||(g=.3*e),h<Math.abs(d)?(h=d,f=g/4):f=g/(2*Math.PI)*Math.asin(d/h),h*Math.pow(2,-10*b)*Math.sin(2*(b*e-f)*Math.PI/g)+d+c)},easeInOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;return 0===b?c:2===(b/=e/2)?c+d:(g||(g=.3*e*1.5),h<Math.abs(d)?(h=d,f=g/4):f=g/(2*Math.PI)*Math.asin(d/h),1>b?-.5*h*Math.pow(2,10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g)+c:h*Math.pow(2,-10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g)*.5+d+c)},easeInBack:function(a,b,c,d,e,f){return void 0===f&&(f=1.70158),d*(b/=e)*b*((f+1)*b-f)+c},easeOutBack:function(a,b,c,d,e,f){return void 0===f&&(f=1.70158),d*((b=b/e-1)*b*((f+1)*b+f)+1)+c},easeInOutBack:function(a,b,c,d,e,f){return void 0===f&&(f=1.70158),(b/=e/2)<1?d/2*b*b*(((f*=1.525)+1)*b-f)+c:d/2*((b-=2)*b*(((f*=1.525)+1)*b+f)+2)+c},easeInBounce:function(a,b,c,d,e){return d-jQuery.easing.easeOutBounce(a,e-b,0,d,e)+c},easeOutBounce:function(a,b,c,d,e){return(b/=e)<1/2.75?7.5625*d*b*b+c:2/2.75>b?d*(7.5625*(b-=1.5/2.75)*b+.75)+c:2.5/2.75>b?d*(7.5625*(b-=2.25/2.75)*b+.9375)+c:d*(7.5625*(b-=2.625/2.75)*b+.984375)+c},easeInOutBounce:function(a,b,c,d,e){return e/2>b?.5*jQuery.easing.easeInBounce(a,2*b,0,d,e)+c:.5*jQuery.easing.easeOutBounce(a,2*b-e,0,d,e)+.5*d+c}}),r=(b.Tween=k.extend({__init:function(a,b){b=b||{},this._super(),this._target=a,this._steps=[],this._loops=void 0===b.loops?1:b.loops,this._initEvent(),this.paused=!1,this.play()},_initEvent:function(){var a,b=this,c=this._target,d=this._steps,e=this._loops,f=0,h={},i=0;this._onStep=function(j){if(!b.paused){var k=d[f],l=k.props,m=k.duration||0,n=k.ease||q.linear;void 0===a&&(a={},g(l,function(b,d){h[d]=void 0===h[d]?c[d]:h[d],a[d]=c[d]},c)),i=Math.min(i+j,m),g(l,function(b,d){c[d]=m>0?n(i,a[d],b-a[d],m):b}),i===m&&(a=void 0,i=0,++f>=d.length&&(f=0,e>0&&0===--e?(b.pause(),b.emit("complete")):g(h,function(a,b){c[b]=a})))}}},wait:function(a){return this._steps.push({duration:a}),this},from:function(a){return this._steps.push({props:a}),this},to:function(a,b,c){return this._steps.push({props:a,duration:b,ease:c}),this},play:function(){return this.paused=!1,this._target.on("step",this._onStep),this},pause:function(){return this.paused=!0,this._target.off("step",this._onStep),this}}),b.DisplayObject=k.extend({__init:function(a){this._super(),this.canvas=a||document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.name="",this.tag="",this.stage=null,this.paused=!1,this.touchable=!0,this.touchChildren=!0,this._dirty=!0,this._touches=[],this._children=[];var b={opacity:1,background:null};g(b,function(a,c){Object.defineProperty(this,c,{set:function(a){b[c]!==a&&(b[c]=a),this.update()},get:function(){return b[c]}})},this),Object.defineProperty(this,"width",{set:function(a){this._onResize(a,this.canvas.height)},get:function(){return this.canvas.width}}),Object.defineProperty(this,"height",{set:function(a){this._onResize(this.canvas.width,a)},get:function(){return this.canvas.height}})},_onTouch:function(a){if(this.touchable){var b=!1,c=a.type;if(this.touchChildren)for(var d=this._children,e=a.identifier,f=new i(a.x,a.y),g=d.length-1;g>=0;--g){var h=d[g];if(h.visible&&h.touchable){var j=!1,k=h._touches,l=h.getTransform().invert().vectorMultiply(f),n=l.x>=0&&l.y>=0&&l.x<=h.width&&l.y<=h.height;switch(c){case"touchstart":n&&(j=!0,k[e]=!0);break;case"touchmove":k[e]&&(j=!0);break;case"touchend":k[e]&&(j=!0,k[e]=!1);break;case"touchtap":n&&void 0!==k[e]&&(j=!0),delete k[e]}if(j){var o=new m(c,l.x,l.y,a.globalX,a.globalY,e);h._onTouch(o),b=b||o.isStopped();break}}}b?a.stopPropagation():this.emit(c,a)}},_onAddedToStage:function(a){this.stage=a,this.emit("addedtostage"),g(this._children,function(b){b._onAddedToStage(a)})},_onRemovedFromStage:function(){this.stage=null,this.emit("removedfromstage"),g(this._children,function(a){a._onRemovedFromStage()})},_onResize:function(a,b){var c=this.width,d=this.height;if(a!==c||b!==d){var e=new n({width:c,height:d},{width:a,height:b});this.emit("resize",e),e.isDefaultPrevented()||(this.canvas.width=a,this.canvas.height=b,this.update())}},render:function(){if(this._dirty){var a=this.context,b=this._children,c=new l("render");a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,this.width,this.height),a.beginPath(),this.background&&(a.save(),a.fillStyle=this.background,a.fillRect(0,0,this.width,this.height),a.restore()),this.emit("render",c),c.isDefaultPrevented()||g(b,function(b){if(b.visible&&b.opacity){var c=b.getTransform();b.render(),a.globalAlpha=b.opacity,1===c.a&&0===c.b&&0===c.c&&1===c.d?a.drawImage(b.canvas,b.x,b.y,b.width,b.height):(a.save(),a.setTransform(c.a,c.b,c.c,c.d,c.tx,c.ty),a.drawImage(b.canvas,0,0,b.width,b.height),a.restore())}}),this.emit("paint",a),this._dirty=!1}return this},tick:function(a){return this.paused||(g(this._children,function(b){b.tick(a)}),this.emit("step",a)),this},update:function(){return this._dirty=!0,this.updateParent(),this},updateParent:function(){return this.parent&&this.parent.update(),this},addChild:function(a){return this.addChildAt(a),this},addChildAt:function(a,b){return a.parent&&a.parent.removeChild(a),a.parent=this,this.stage&&a._onAddedToStage(this.stage),void 0===b?this._children.push(a):this._children.splice(b,0,a),this.update(),this},getChildByName:function(a){var b;return g(this._children,function(c){return c.name===a?(b=c,!1):void 0}),b},getChildrenByTag:function(a){var b=[];return g(this._children,function(c){c.tag===a&&b.push(c)}),b},getChildAt:function(a){return this._children[a]},getChildIndex:function(a){var b=-1;return g(this._children,function(c,d){c===a&&(b=d)}),b},swapChildren:function(a,b){var c=this.getChildIndex(a),d=this.getChildIndex(b);return c>=0&&d>=0&&this.swapChildrenAt(c,d),this},swapChildrenAt:function(a,b){if(a!==b){var c=this._children[a],d=this._children[b];c&&d&&(this._children[a]=d,this._children[b]=c,this.update())}return this},sortChildren:function(a){return this._children.sort(a),this},getAllChildren:function(){return this._children},removeChild:function(a,b){for(var c=this._children,d=c.length-1;d>=0;--d)c[d]===a&&this.removeChildAt(d,b);return this},removeChildAt:function(a,b){var c=this._children.splice(a,1)[0];return c&&(b?c.dispose():(c.parent=null,c.stage&&c._onRemovedFromStage()),this.update()),this},removeChildrenByTag:function(a,b){for(var c=this._children,d=c.length-1;d>=0;--d)c[d].tag===a&&this.removeChildAt(d,b);return this},removeAllChildren:function(a){return g(this._children,function(b){b.parent=null,b.stage&&b._onRemovedFromStage(),a&&b.dispose()}),this._children=[],this.update(),this},play:function(){return this.paused=!1,this},pause:function(){return this.paused=!0,this},dispose:function(){return this.parent&&this.parent.removeChild(this),this.removeAllChildren(!0),this._super(),this}})),s=b.Sprite=r.extend({__init:function(){this._super(),this.parent=null;var a={x:0,y:0,skewX:0,skewY:0,scaleX:1,scaleY:1,anchorX:0,anchorY:0,anchorOffsetX:0,anchorOffsetY:0,rotation:0,visible:!0};g(a,function(b,c){Object.defineProperty(this,c,{set:function(b){a[c]=b,this.updateParent()},get:function(){return a[c]}})},this)},getTransform:function(){var a=new j,b=this.anchorOffsetX+this.anchorX*this.width,c=this.anchorOffsetY+this.anchorY*this.height;return a.translate(-b,-c),a.rotate(this.rotation).scale(this.scaleX,this.scaleY).skew(this.skewX,this.skewY),a.translate(this.x+b,this.y+c),a},show:function(){return this.visible=!0,this},hide:function(){return this.visible=!1,this}});b.ImageView=s.extend({__init:function(a){this._super(),this.setImage(a),this.on("render",this._onRender)},setImage:function(a){this._image=a,this.update()},_onRender:function(){var a=this.context;a.drawImage(this._image,0,0,this.width,this.height)}}),b.ScrollView=s.extend({__init:function(a){this._super(),this._content=null,this._scrollPos={top:0,left:0},this._initTouch(),this.setContent(a),this.on("render",this._onRender),Object.defineProperty(this,"scrollTop",{set:function(a){this._onScroll(a,this.scrollLeft)},get:function(){return this._scrollPos.top}}),Object.defineProperty(this,"scrollLeft",{set:function(a){this._onScroll(this.scrollTop,a)},get:function(){return this._scrollPos.left}})},_initTouch:function(){var a,b,c,d,e;this.on({touchstart:function(e){a={top:this.scrollTop,left:this.scrollLeft},d=+new Date,b=c=e},touchmove:function(f){var g=+new Date-d,h=this.scrollTop=a.top-f.y+b.y,i=this.scrollLeft=a.left-f.x+b.x;e={top:(f.y-c.y)/g,left:(f.x-c.x)/g},d=+new Date,c=f,(this.scrollTop!==h||this.scrollLeft!==i)&&f.stopPropagation()},touchend:function(){a=b=c=d=null},step:function(b){if(!a&&e){var c=.9,d=1,f=(this.scrollTop,this.scrollLeft,(e.top*=c)*b),g=(e.left*=c)*b;this.scrollTop-=f,this.scrollLeft-=g,Math.sqrt(f*f+g*g)<d&&(e=null)}}})},_onScroll:function(a,b){var c=this.getContent();if(c){var d={top:Math.max(0,Math.min(a,c.height-this.height)),left:Math.max(0,Math.min(b,c.width-this.width))},e=new l("scroll",this._scrollPos,d);this.emit("scroll",e),e.isDefaultPrevented()||(this._scrollPos=d,this.update())}},_onRender:function(){var a=this.context,b=this._children;return this.background?(a.save(),a.fillStyle=this.background,a.fillRect(0,0,this.width,this.height),a.restore()):a.clearRect(0,0,this.width,this.height),g(b,function(b){if(b.visible){var c=b.getTransform();b.render(),a.save(),a.globalAlpha=b.opacity,a.setTransform(c.a,c.b,c.c,c.d,c.tx-this.scrollLeft,c.ty-this.scrollTop),a.drawImage(b.canvas,0,0,b.width,b.height),a.restore()}},this),!1},setContent:function(a){this.removeContent(),a&&(this._children[0]=a)},getContent:function(){return this._children[0]},removeContent:function(a){var b=this.getContent();b&&(b.parent=null,a&&b.dispose(),this._children=[])},addChildAt:function(a){this.setContent(a),console.warn("NotSupportError: Please use `setConent` instead.")},removeChildAt:function(a,b){this.removeContent(b),console.warn("NotSupportError: Please use `removeConent` instead.")},removeAllChildren:function(a){this.removeContent(a)}}),b.TextField=s.extend({__init:function(a,b){this._super(),this.on("render",this._onRender),b=b||{};var c={bold:b.bold||!1,italic:b.italic||!1,fontSize:b.fontSize||12,color:b.color||"black",textAlign:b.textAlign||"left",lineHeight:b.lineHeight||"120%",strokeSize:b.strokeSize||0,strokeStyle:b.strokeStyle||null,fontFamily:b.fontFamily||"Arial",breakWord:b.breakWord||!1,autoResize:b.autoResize||!1,paddingTop:b.paddingTop||0,paddingLeft:b.paddingLeft||0,paddingRight:b.paddingRight||0,paddingBottom:b.paddingBottom||0,maxWidth:b.maxWidth||16777215,maxHeight:b.maxHeight||16777215};g(c,function(a,b){Object.defineProperty(this,b,{set:function(a){c[b]!==a&&(c[b]=a,this._updateFont(),this.update())},get:function(){return c[b]}})},this),Object.defineProperty(this,"textWidth",{set:function(){},get:function(){return this._getTextRange(this._splitLines()).width}}),Object.defineProperty(this,"textHeight",{set:function(){},get:function(){return this._getTextRange(this._splitLines()).height}}),Object.defineProperty(this,"text",{set:function(b){b=void 0===b||null===b?"":""+b,a!==b&&(a=b,this.update())},get:function(){return a}}),this.text=a,this._updateFont()},_updateFont:function(){var a=this.context,b=this.italic?"italic":"normal",c=this.bold?"bold":"normal",d=this.fontSize+"px";a.font=b+" "+c+" "+d+" "+this.fontFamily,a.textAlign=this.textAlign,a.textBaseline="top"},_getLineHeight:function(){var a=this.lineHeight;return/%/.test(a)?parseFloat(a)*this.fontSize/100:a},_splitLines:function(){var a=[],b=this.context,c=this.text.split("\n"),d=this.breakWord,e=this.autoResize?this.maxWidth:this.width;return e-=this.paddingLeft+this.paddingRight,g(c,function(c){if(b.measureText(c).width<e)a.push(c);else if(d)for(var f=0;c.length>0;)++f,(b.measureText(c.substr(0,f+1)).width>e||f===c.length)&&(a.push(c.substr(0,f)),c=c.substr(f),f=0);else{for(var g,h=[],i="",j=c.split(/\b/);j.length;)g=j.shift(),/\w+/i.test(g)?h.push(g):h=h.concat(g.split(""));for(;h.length;)g=h[0],b.measureText(i+g).width>e&&i?(a.push(i),i=""):i+=h.shift();i&&a.push(i)}},this),a},_onResize:function(a,b){this._super(a,b),this._updateFont()},_onRender:function(){var a=this._splitLines();if(this.autoResize){var b=this._getTextRange(a);this.width=Math.min(b.width,this.maxWidth)+this.paddingLeft+this.paddingRight,this.height=Math.min(b.height,this.maxHeight)+this.paddingTop+this.paddingBottom}this._drawLines(a)},_getTextRange:function(a){var b=0,c=0,d=this.context,e=this._getLineHeight();return g(a,function(a){b=Math.max(b,d.measureText(a).width),c+=e}),{width:b,height:c}},_drawLines:function(a){var b=0,c=0,d=this.paddingLeft,e=this.paddingTop,f=this._getLineHeight();b="center"===this.textAlign?d+this.width/2:"right"===this.textAlign?d+this.width:d,g(a,function(a,d){c=e+d*f,this._drawText(a,b,c)},this)},_drawText:function(a,b,c){var d=this.context;d.save(),this.color&&(d.fillStyle=this.color,d.fillText(a,b,c)),this.strokeStyle&&(d.lineWidth=this.strokeSize,d.strokeStyle=this.strokeStyle,d.strokeText(a,b,c)),d.restore()},setText:function(a){return this.text=a,this}}),b.Stage=r.extend({__init:function(a){"string"==typeof a&&(a=document.getElementById(a)),this._super(a),this.__dispatchEvents(),this.stage=this},__dispatchEvents:function(){function a(a,b){var c=d.getBoundingClientRect(),e=c.width/d.width,f=c.height/d.height,g=(b.pageX-c.left)/e,h=(b.pageY-c.top)/f,i=b.identifier||0;return new m(a,g,h,g,h,i)}function b(b,d){var e=d.changedTouches;e?(e=Array.prototype.slice.call(e),g(e,function(d){c._onTouch.call(c,a(b,d))})):c._onTouch.call(c,a(b,d))}var c=this,d=this.canvas;if("ontouchend"in document)d.addEventListener("touchstart",function(a){b("touchstart",a),a.preventDefault()}),d.addEventListener("touchmove",function(a){b("touchmove",a),a.preventDefault()}),d.addEventListener("touchend",function(a){b("touchend",a),b("touchtap",a),a.preventDefault()}),d.addEventListener("touchcancel",function(a){b("touchend",a),b("touchtap",a)});else{var e=!1;d.addEventListener("mousedown",function(a){e=!0,b("touchstart",a)}),d.addEventListener("mousemove",function(a){e&&b("touchmove",a)}),d.addEventListener("mouseup",function(a){e=!1,b("touchend",a),b("touchtap",a)})}}})}return b});